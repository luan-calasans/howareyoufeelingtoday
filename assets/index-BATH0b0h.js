import{h as U,d as Y,e as j,a as z,g as B,r as y,f as V,j as r,C as w,I as W,L as G,m as H,B as N,T as J}from"./index-D_X4IM2p.js";import{o as A,p as m,s as o,q as P,r as h,t as R,v as L,n as M,w as X,u as T,E as Z,d as _,f as F}from"./date-Cwnh4C2S.js";import{M as ee}from"./Modal-DNHiGHIN.js";const v=A({id:o().min(1),entryId:m([o(),h("")]).optional().transform(e=>e===""||!e?void 0:e),date:m([o(),P()]).transform(e=>{if(!e)return"";if(typeof e=="object"&&e!==null&&"getFullYear"in e){const a=e,c=a.getFullYear(),n=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${c}-${n}-${s}`}const t=String(e).trim();if(t&&t!==""){const a=new Date(t);if(!isNaN(a.getTime())){const c=a.getFullYear(),n=String(a.getMonth()+1).padStart(2,"0"),s=String(a.getDate()).padStart(2,"0");return`${c}-${n}-${s}`}if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t}return t}),user:o().min(1),request:o().min(1,"Pedido de oração é obrigatório"),status:m([L(["pending","answered","archived"]),h(""),o()]).transform(e=>{if(!e||e==="")return"pending";const t=String(e).toLowerCase().trim();return["pending","answered","archived"].includes(t)?t:"pending"}).default("pending"),answeredDate:m([o(),h(""),R()]).optional().transform(e=>e===""||!e?void 0:e),answer:m([o(),h(""),R()]).optional().transform(e=>e===""||!e?void 0:e),createdAt:m([o(),P()]).transform(e=>typeof e=="object"&&e!==null&&"toISOString"in e&&typeof e.toISOString=="function"?e.toISOString():String(e||"")),updatedAt:m([o(),P()]).transform(e=>typeof e=="object"&&e!==null&&"toISOString"in e&&typeof e.toISOString=="function"?e.toISOString():String(e||""))}).transform(e=>({...e,entryId:e.entryId===""||!e.entryId?void 0:e.entryId,answeredDate:e.answeredDate===""||!e.answeredDate?void 0:e.answeredDate,answer:e.answer===""||!e.answer?void 0:e.answer}));A({entryId:o().optional(),date:o().regex(/^\d{4}-\d{2}-\d{2}$/),user:o(),request:o().min(1,"Pedido de oração é obrigatório")});A({status:L(["pending","answered","archived"]).optional(),answeredDate:o().optional(),answer:o().optional()});function $(e){if(!e.prayerRequest||e.prayerRequest.trim()==="")return null;const t=e.prayerStatus==="answered"||e.prayerStatus==="archived"?e.prayerStatus:"pending";return{id:e.id,entryId:e.id,date:e.date,user:e.user,request:e.prayerRequest,status:t,answeredDate:e.prayerAnsweredDate&&e.prayerAnsweredDate.trim()!==""?e.prayerAnsweredDate:void 0,answer:e.prayerAnswer&&e.prayerAnswer.trim()!==""?e.prayerAnswer:void 0,createdAt:e.createdAt,updatedAt:e.updatedAt}}async function re(e={}){const t=await M({user:e.user}),a=[];for(const n of t){const s=$(n);s&&(e.status&&e.status.trim()!==""?s.status===e.status&&a.push(s):a.push(s))}const c=X(v);try{const n=c.safeParse(a);if(n.success)return n.data;const s=[];for(const d of a){if(!d||typeof d!="object")continue;const u=v.safeParse(d);u.success&&s.push(u.data)}return s}catch(n){return console.error("Error parsing prayers:",n),[]}}async function te(e){throw new Error("Prayer requests must be created as part of an entry. Use createEntry instead.")}async function se(e,t){const a=await U.post("",t,{params:{action:"updatePrayer",id:e},includeAccessKeyInParams:!0});if(!a.ok||!a.data)throw new Error(a.error||"Failed to update prayer request");const n=(await M({})).find(d=>d.id===e);if(!n)throw new Error("Entry not found after update");const s=$(n);if(!s)throw new Error("Failed to convert entry to prayer request");return v.parse(s)}async function ae(e){throw new Error("Deleting prayer requests is not yet supported. Prayer requests are tied to entries.")}function ne(e={}){return Y({queryKey:["prayers",e],queryFn:()=>re(e),staleTime:5*60*1e3,gcTime:10*60*1e3,refetchOnWindowFocus:!1})}function pe(){const e=j();return T({mutationFn:t=>te(),onSuccess:()=>{e.invalidateQueries({queryKey:["prayers"],refetchType:"active"})}})}function ie(){const e=j();return T({mutationFn:({id:t,data:a})=>se(t,a),onSuccess:()=>{e.invalidateQueries({queryKey:["prayers"],refetchType:"active"}),e.invalidateQueries({queryKey:["entries"],refetchType:"active"})}})}function me(){const e=j();return T({mutationFn:t=>ae(),onSuccess:()=>{e.invalidateQueries({queryKey:["prayers"],refetchType:"active"})}})}function ye(){const{t:e}=z(),{partner1Name:t,partner2Name:a}=B(),[c,n]=y.useState(""),s=V(),d=j(),{data:u,isLoading:f,isFetching:p,isError:K,error:C,refetch:g}=ne({}),D=ie(),[Q,S]=y.useState(!1),[x,b]=y.useState(null);y.useEffect(()=>{g()},[]),y.useEffect(()=>{s.pathname==="/prayers"&&(d.invalidateQueries({queryKey:["entries"]}),g())},[s.pathname,d,g]);const E=i=>i==="Partner 1"?t:i==="Partner 2"?a:i,k=i=>{b(i),S(!0)},O=async i=>{if(x)try{await D.mutateAsync({id:x.id,data:{status:"answered",answer:i.trim(),answeredDate:new Date().toISOString().split("T")[0]}}),S(!1),b(null),d.invalidateQueries({queryKey:["entries"]}),g()}catch(l){console.error("Failed to update prayer:",l)}},q=(u==null?void 0:u.filter(i=>{var I;if(!c.trim())return!0;const l=c.toLowerCase();return i.request.toLowerCase().includes(l)||((I=i.answer)==null?void 0:I.toLowerCase().includes(l))||i.user.toLowerCase().includes(l)||E(i.user).toLowerCase().includes(l)||i.date.includes(l)}))||[];return K&&!p?r.jsxs("div",{className:"space-y-6",children:[r.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:e("prayers")}),r.jsx("p",{className:"text-gray-600 mt-1",children:e("prayerReminderMessage")||"Pedidos de oração vinculados aos registros"})]})}),r.jsx(w,{children:r.jsx(Z,{message:C instanceof Error?C.message:e("failedToLoad"),onRetry:()=>g()})})]}):r.jsxs("div",{className:"space-y-6",children:[r.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:e("prayers")}),r.jsx("p",{className:"text-gray-600 mt-1",children:e("prayerReminderMessage")||"Pedidos de oração vinculados aos registros"})]})}),r.jsx(w,{children:r.jsx(W,{type:"text",placeholder:e("searchPrayers"),value:c,onChange:i=>n(i.target.value),className:"w-full"})}),(f||p)&&r.jsx("div",{className:"flex justify-center items-center min-h-[400px]",children:r.jsx(G,{})}),!f&&!p&&(!q||q.length===0)?r.jsx(w,{children:r.jsx(_,{message:e("noPrayersFound")})}):!f&&!p&&r.jsx("div",{className:"grid gap-4",children:q.map((i,l)=>r.jsx(oe,{prayer:i,index:l,translateUser:E,onMarkAsAnswered:k,t:e},i.id))}),x&&r.jsx(de,{isOpen:Q,onClose:()=>{S(!1),b(null)},prayer:x,onSubmit:O,isLoading:D.isPending,t:e})]})}function oe({prayer:e,index:t,translateUser:a,onMarkAsAnswered:c,t:n}){const s=d=>{switch(d){case"answered":return"bg-green-100 text-green-800 border-green-200";case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"archived":return"bg-gray-100 text-gray-800 border-gray-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};return r.jsx(H.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:t*.05},children:r.jsxs(w,{children:[r.jsx("div",{className:"flex items-start justify-between mb-3",children:r.jsxs("div",{className:"flex-1",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[r.jsx("h3",{className:"font-semibold text-gray-900",children:a(e.user)}),r.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium border ${s(e.status)}`,children:n(e.status)})]}),r.jsx("p",{className:"text-sm text-gray-600",children:F(e.date)})]})}),r.jsx("div",{className:"mb-4",children:r.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:e.request})}),e.status==="answered"&&e.answer&&r.jsxs("div",{className:"mt-4 p-3 bg-green-50 rounded-lg border border-green-200",children:[r.jsxs("p",{className:"text-sm font-medium text-green-900 mb-1",children:[n("prayerAnswer"),":"]}),r.jsx("p",{className:"text-sm text-green-800 whitespace-pre-wrap",children:e.answer}),e.answeredDate&&r.jsxs("p",{className:"text-xs text-green-600 mt-2",children:[n("answeredDate"),":"," ",F(e.answeredDate.split("T")[0])]})]}),e.status==="pending"&&r.jsx("div",{className:"mt-4",children:r.jsx(N,{variant:"outline",size:"sm",onClick:()=>c(e),children:n("markAsAnswered")})})]})})}function de({isOpen:e,onClose:t,prayer:a,onSubmit:c,isLoading:n,t:s}){const[d,u]=y.useState(""),f=p=>{p.preventDefault(),d.trim()&&(c(d.trim()),u(""))};return y.useEffect(()=>{e||u("")},[e]),r.jsx(ee,{isOpen:e,onClose:t,title:s("markAsAnswered"),children:r.jsxs("form",{onSubmit:f,className:"space-y-4",children:[r.jsxs("div",{className:"mb-4",children:[r.jsxs("p",{className:"text-sm font-medium text-gray-700 mb-2",children:[s("prayerRequest"),":"]}),r.jsx("p",{className:"text-gray-600 text-sm whitespace-pre-wrap",children:a.request})]}),r.jsx(J,{label:s("prayerAnswer"),value:d,onChange:p=>u(p.target.value),placeholder:s("prayerRequestPlaceholder")||"Como a oração foi respondida?",rows:5,required:!0}),r.jsxs("div",{className:"flex items-center justify-end gap-3 pt-4",children:[r.jsx(N,{type:"button",variant:"outline",onClick:t,disabled:n,children:s("cancel")}),r.jsx(N,{type:"submit",isLoading:n,disabled:n,children:s("confirm")})]})]})})}export{ye as PrayersPage,pe as useCreatePrayer,me as useDeletePrayer,ne as usePrayers,ie as useUpdatePrayer};
